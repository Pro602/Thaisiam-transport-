<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏ô‡∏™‡πà‡∏á</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(120deg, #a8edea, #fed6e3);
            text-align: center;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        h2 {
            color: #007BFF;
            font-size: 22px;
            font-weight: bold;
        }
        
        .truck {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        ul {
            list-style: none;
            padding: 0;
        }
        
        li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f4f4f4;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        
        .status {
            font-weight: bold;
        }
        
        .pending {
            color: gray;
        }
        
        .in-progress {
            color: orange;
        }
        
        .completed {
            color: green;
        }
        
        button {
            padding: 8px 15px;
            font-size: 14px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        
        .start-btn {
            background: blue;
            color: white;
        }
        
        .complete-btn {
            background: green;
            color: white;
            display: none;
        }
        
        .timestamp.shipping {
            color: orange;
            /* ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á */
        }
        
        .timestamp.delivered {
            color: green;
            /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß */
        }
    </style>
</head>

<body>

    <h2>üöö ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏ô‡∏™‡πà‡∏á</h2>

    <div id="loginContainer">
        <label>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠Update Status):</label>
        <input type="password" id="passwordInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
        <button onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="container">
        <div id="truckData"></div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxRojPjjz6nRkEG9bcubeXk6a8wtaDFsSpNL0DFcIVGc3vg7EyrNMu-rVEZJ-4Ashc-/exec";
        let loggedInTruck = null;
        let truckData = [];

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å fetchData ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
        fetchData();

        function login() {
            const password = document.getElementById("passwordInput").value;

            if (!password) {
                Swal.fire({
                    title: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô",
                    icon: "warning",
                    text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
                    timer: 3000,
                    showConfirmButton: false
                });
                return;
            }

            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô truckData ‡∏ß‡πà‡∏≤‡∏°‡∏µ license_plate ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏°‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const foundTruck = truckData.find(truck => {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á license_plate ‡∏Å‡πà‡∏≠‡∏ô
            let lastFour = null;
            if (truck.license_plate.length === 9) {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ 9 ‡∏ï‡∏±‡∏ß -> ‡∏ï‡∏±‡∏î 2 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤ 4 ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á
                lastFour = truck.license_plate.slice(0, -2).slice(-4);
            } else if (truck.license_plate.length === 8) {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ 8 ‡∏ï‡∏±‡∏ß -> ‡∏ï‡∏±‡∏î 2 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤ 4 ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á
                lastFour = truck.license_plate.slice(0, -2).slice(-4);
            }

            // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö password
            return lastFour === password;
        });

            if (!foundTruck) {
                Swal.fire({
                    title: "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
                    icon: "error",
                    text: "‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà",
                    timer: 3000,
                    showConfirmButton: false
                });
                return;
            }

            loggedInTruck = password;
            Swal.fire({
                title: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
                icon: "success",
                text: `‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ: ${foundTruck.license_plate}`,
                timer: 3000, // ‡∏õ‡∏¥‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                showConfirmButton: false // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° OK
            });

            renderTrucks(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        }

        function fetchData() {
            fetch(API_URL)
                .then(response => response.json())
                .then(data => {
                    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (row ‡∏ó‡∏µ‡πà‡∏°‡∏µ date ‡πÄ‡∏õ‡πá‡∏ô "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà")
                    truckData = data.filter(row => row.date !== "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");

                    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    truckData = truckData.filter(item => isToday(item.date));

                    renderTrucks(); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
                })
                .catch(error => console.error("Error fetching data:", error));
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        function isToday(dateString) {
            if (!dateString) return false;

            // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å API ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Date
            const dateFromAPI = new Date(dateString);
            const today = new Date();

            // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ß‡∏±‡∏ô ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡∏õ‡∏µ
            return (
                dateFromAPI.getDate() === today.getDate() &&
                dateFromAPI.getMonth() === today.getMonth() &&
                dateFromAPI.getFullYear() === today.getFullYear()
            );
        }

        function updateStatus(id, newStatus) {
            if (!id) {
                console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞");
                return;
            }

            Swal.fire({
                title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...",
                text: "‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞",
                icon: "info",
                showConfirmButton: false,
                allowOutsideClick: false,
                timer: 3000
            });

            const url = `${API_URL}?id=${id}&status=${encodeURIComponent(newStatus)}`;

            setTimeout(() => {
                fetch(url, {
                        method: "GET"
                    })
                    .then(response => response.json())
                    .then(result => {
                        Swal.fire({
                            title: "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!",
                            text: "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
                            icon: "success",
                            timer: 1500,
                            showConfirmButton: false
                        });
                        fetchData();
                    })
                    .catch(error => {
                        console.error("‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
                        Swal.fire({
                            title: "‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!",
                            text: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ",
                            icon: "error"
                        });
                    });
            }, 1500);
        }

        function renderTrucks() {
            const container = document.getElementById("truckData");
            container.innerHTML = "";

            const groupedByTruck = {};

            truckData.forEach(item => {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á license_plate
            let lastFour = null;
            if (item.license_plate.length === 9) {
                lastFour = item.license_plate.slice(0, -2).slice(-4);
            } else if (item.license_plate.length === 8) {
                lastFour = item.license_plate.slice(0, -2).slice(-4);
            }
            if (loggedInTruck && lastFour !== loggedInTruck) {
                return; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏õ
            }

                const key = `${item.license_plate} - ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏µ‡πà ${item.trip}`;
                if (!groupedByTruck[key]) groupedByTruck[key] = [];
                groupedByTruck[key].push(item);
            });

            Object.keys(groupedByTruck).forEach(truck => {
                        const truckDiv = document.createElement("div");
                        truckDiv.classList.add("truck");

                        truckDiv.innerHTML = `<h2>üöö ${truck}</h2><ul></ul>`;
                        const list = truckDiv.querySelector("ul");

                        groupedByTruck[truck].forEach(item => {
                                    const li = document.createElement("li");

                                    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î timestamp ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                                    let timestamp = "";
                                    let timestampClass = "";

                                    if (item.status === "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß") {
                                        timestamp = `‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ${formatDateTime(item.timestamp)}`;
                                        timestampClass = "delivered";
                                    } else if (item.status === "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á") {
                                        timestamp = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á ${formatDateTime(item.timestamp)}`;
                                        timestampClass = "shipping";
                                    } else {
                                        timestamp = formatDateTime(item.timestamp);
                                    }

                                    li.innerHTML = `
                <span class="status">${item.customer}</span>
                <span class="timestamp ${timestampClass}">${timestamp}</span>
                ${loggedInTruck ? ` 
                    <button class="start-btn" onclick="updateStatus('${item.id}', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á')">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
                    <button class="complete-btn" onclick="updateStatus('${item.id}', '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß')">‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</button>
                ` : ""}
            `;

            const startBtn = li.querySelector(".start-btn");
            const completeBtn = li.querySelector(".complete-btn");

            if (startBtn) {
                if (item.status === "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á") {
                    startBtn.style.display = "none";
                } else if (item.status === "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß") {
                    startBtn.style.display = "none";
                }
            }

            if (completeBtn) {
                if (item.status === "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á") {
                    completeBtn.style.display = "inline-block";
                } else if (item.status === "‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß") {
                    completeBtn.style.display = "none";
                }
            }

            list.appendChild(li);
        });

        container.appendChild(truckDiv);
    });
}


        function formatDateTime(timestamp) {
            if (!timestamp || isNaN(new Date(timestamp))) {
                return "";  
            }

            const date = new Date(timestamp);  
            const year = date.getFullYear();   
            const month = String(date.getMonth() + 1).padStart(2, '0');  
            const day = String(date.getDate()).padStart(2, '0');  

            const hours = String(date.getHours()).padStart(2, '0');   
            const minutes = String(date.getMinutes()).padStart(2, '0');  
            const seconds = String(date.getSeconds()).padStart(2, '0');  

            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;  
        }


        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
        loadSheetData();

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(loadSheetData, 30000);
    </script>

</body>
</html>
